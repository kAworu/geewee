$('#recaptcha').html("<%=ejs render(:partial => 'shared/recaptcha') %>");

<% if @captcha_valid and not @comment.valid?
  flash[:error] = error_messages_for('comment')
end %>

<% [:notice, :error].each do |lvl| %>
  <% unless flash[lvl].blank? %>
    $('#preview').hide();
    $('#flash-<%= lvl %>').fadeOut('slow', function() {
      $('#flash-<%= lvl %>').html("<%=ejs flash[lvl] %>").fadeIn('slow');
    });
  <% else %>
    $('#flash-<%= lvl %>').hide();
  <% end %>
<% end %>

<% if @captcha_valid and @comment.valid? %>
  <% if @preview %>
    $('#preview').fadeOut('slow', function() {
      $('#preview-comment').html("<ol class='comments'><%=ejs render(:partial => @comment) %></ol>");
      $('#preview').fadeIn('slow');
    });
  <% else %>
    $('#preview').hide();
    $('#new_comment').resetForm();
    $('#comments').append("<%=ejs render(:partial => @comment) %>");
    $('#comment_<%= @comment.id %>').css('display', 'none').show('slow');
  <% end %>
<% end %>
